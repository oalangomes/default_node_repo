name: ðŸ”„ Auto PR main â†’ master (com cobertura e changelog)

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'coverage/**'
      - 'badges/**'

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-pr-main-to-master-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-and-pr:
    runs-on: ubuntu-latest
    env:
      # Define a branch de destino para sincronizaÃ§Ã£o. Caso SYNC_BRANCH nÃ£o exista nas variÃ¡veis,
      # a branch main serÃ¡ usada por padrÃ£o.
      SYNC_BRANCH: ${{ vars.SYNC_BRANCH || 'main' }}

    steps:
      - name: ðŸ“‚ Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš–ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ”§ Instala dependÃªncias
        run: npm ci

      - name: ðŸ“Š Roda testes com cobertura
        run: npm run test:coverage

      - name: ðŸ—•ï¸ Atualiza badge e status
        run: npm run coverage:update

      - name: ðŸ“ˆ Extrai cobertura
        id: cobertura
        run: |
          if [ ! -f coverage/coverage-summary.json ]; then
            echo "âŒ Arquivo de cobertura nÃ£o encontrado!"
            exit 1
          fi

          valor=$(jq '.total.lines.pct' coverage/coverage-summary.json)
          echo "coverage=$valor" >> "$GITHUB_OUTPUT"
          echo "ðŸ“Š Cobertura atual: $valor%"

          echo "TABLE_COVERAGE<<EOF" >> $GITHUB_ENV
          echo '| Arquivo | % Linhas | % Branches | % FunÃ§Ãµes | % DeclaraÃ§Ãµes |' >> $GITHUB_ENV
          echo '|---------|----------|------------|-----------|---------------|' >> $GITHUB_ENV
          jq -r 'to_entries[] | select(.key != "total") | "| \(.key) | \(.value.lines.pct)% | \(.value.branches.pct)% | \(.value.functions.pct)% | \(.value.statements.pct)% |"' coverage/coverage-summary.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: âœ… Verifica cobertura mÃ­nima
        run: |
          coverage=${{ steps.cobertura.outputs.coverage }}
          if (( $(echo "$coverage < 90" | bc -l) )); then
            echo "âŒ Cobertura insuficiente: $coverage% (mÃ­nimo: 90%)"
            echo "ðŸš« PR nÃ£o serÃ¡ criado automaticamente"
            exit 1
          fi
          echo "âœ… Cobertura adequada: $coverage%"

      - name: ðŸ”§ Configura git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ“ ForÃ§a criaÃ§Ã£o de diferenÃ§a entre branches
        id: force_diff
        run: |
          # Garante que estamos na branch main
          git checkout main
          
          # Commita mudanÃ§as de badges se houver
          if [ -n "$(git status --porcelain)" ]; then
            echo "ðŸ“ Commitando mudanÃ§as de badges/cobertura..."
            git add .
            git commit -m "ðŸ¦– Atualiza badges e cobertura ($(date '+%Y-%m-%d %H:%M:%S'))"
            git push origin main
            echo "âœ… Commit de badges enviado"
          fi
          
          # Cria um arquivo temporÃ¡rio com timestamp para forÃ§ar diferenÃ§a
          # MUDANÃ‡A: Movido para fora do diretÃ³rio .github/workflows/
          mkdir -p .github/sync
          echo "# Auto-sync executado em $(date '+%Y-%m-%d %H:%M:%S')" > .github/sync/last-sync.md
          echo "Cobertura: ${{ steps.cobertura.outputs.coverage }}%" >> .github/sync/last-sync.md
          echo "SHA: ${{ github.sha }}" >> .github/sync/last-sync.md
          
          git add .github/sync/last-sync.md
          git commit -m "ðŸ¤– Auto-sync trigger ($(date '+%Y-%m-%d %H:%M:%S'))"
          git push origin main
          echo "âœ… Arquivo de sync criado e enviado"
          
          # Mostra informaÃ§Ãµes das branches
          echo "ðŸ“‹ Ãšltimos commits em main:"
          git log --oneline -3
          
          echo "has_changes=true" >> "$GITHUB_OUTPUT"

      - name: ðŸ”„ Atualiza referÃªncias
        run: |
          git fetch origin main
          git fetch origin ${{ env.SYNC_BRANCH }}
          
          # Debug: mostra diferenÃ§as
          echo "ðŸ“Š Commits Ã  frente de master:"
          git rev-list --count origin/${{ env.SYNC_BRANCH }}..origin/main
          
          echo "ðŸ“‹ Ãšltimos commits em main:"
          git log --oneline origin/main -5
          
          echo "ðŸ“‹ Ãšltimos commits em ${{ env.SYNC_BRANCH }}:"
          git log --oneline origin/${{ env.SYNC_BRANCH }} -5

      - name: ðŸ”¢ Gera changelog
        id: changelog
        run: |
          # Pega os commits entre a branch de destino e main
          COMMITS_AHEAD=$(git rev-list --count origin/${{ env.SYNC_BRANCH }}..origin/main)
          echo "ðŸ“Š Commits Ã  frente: $COMMITS_AHEAD"
          
          if [ "$COMMITS_AHEAD" -gt 0 ]; then
            CHANGELOG=$(git log origin/${{ env.SYNC_BRANCH }}..origin/main --pretty=format:"- %s (%h)" --no-merges | head -10)
            NUM_COMMITS=$COMMITS_AHEAD
          else
            CHANGELOG="- SincronizaÃ§Ã£o automÃ¡tica ($(date '+%Y-%m-%d %H:%M:%S'))"
            NUM_COMMITS=1
          fi

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- AtualizaÃ§Ã£o de configuraÃ§Ãµes/infraestrutura"
          fi

          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$CHANGELOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "num_commits=$NUM_COMMITS" >> "$GITHUB_OUTPUT"
          echo "commits_ahead=$COMMITS_AHEAD" >> "$GITHUB_OUTPUT"

      - name: ðŸ”— Cria PR usando GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Primeiro, verifica se jÃ¡ existe um PR
          PR_EXISTS=$(gh pr list --head auto-sync-main-${{ env.SYNC_BRANCH }} --base ${{ env.SYNC_BRANCH }} --json number --jq length)
          
          if [ "$PR_EXISTS" -gt 0 ]; then
            echo "ðŸ“ PR jÃ¡ existe, fechando e recriando..."
          gh pr close auto-sync-main-${{ env.SYNC_BRANCH }} --delete-branch || true
            sleep 2
          fi
          
          # Cria uma nova branch para o PR
          git checkout -b auto-sync-main-${{ env.SYNC_BRANCH }}
          git push origin auto-sync-main-${{ env.SYNC_BRANCH }} --force
          
          # Cria o PR
          gh pr create \
            --title "ðŸ”„ Auto PR: main â†’ ${{ env.SYNC_BRANCH }} (Cobertura: ${{ steps.cobertura.outputs.coverage }}%)" \
            --body "### ðŸ”„ Merge automÃ¡tico de \`main\` para \`master\`

          **ðŸ“ Cobertura Total**: \`${{ steps.cobertura.outputs.coverage }}%\` âœ…

          **ðŸ“Š Resumo de Cobertura por Arquivo:**
          ${{ env.TABLE_COVERAGE }}

          **ðŸ“‹ MudanÃ§as incluÃ­das (${{ steps.changelog.outputs.num_commits }} commits):**
          ${{ env.CHANGELOG }}

          ---

          **ðŸ¤– PR criado automaticamente**  
          **â° Criado em**: $(date '+%Y-%m-%d %H:%M:%S')  
          **ðŸ” Commit**: ${{ github.sha }}  
          **ðŸ“Š Commits Ã  frente**: ${{ steps.changelog.outputs.commits_ahead }}

          > Este PR serÃ¡ automaticamente atualizado quando novos commits forem feitos na branch \`main\`" \
            --base ${{ env.SYNC_BRANCH }} \
            --head auto-sync-main-${{ env.SYNC_BRANCH }} \
            --reviewer oalangomes \
            --label "ðŸ¤– automated,ðŸ“Š coverage-check,ðŸ”„ sync"
          
          echo "âœ… PR criado com sucesso!"
          
          # Volta para main
          git checkout main

      - name: ðŸ“¢ Resumo da execuÃ§Ã£o
        if: always()
        run: |
          echo "## ðŸ“Š Resumo da ExecuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "- **Cobertura**: ${{ steps.cobertura.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Commits Ã  frente**: ${{ steps.changelog.outputs.commits_ahead }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Status**: Criado/atualizado via GitHub CLI" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: auto-sync-main-master â†’ master" >> $GITHUB_STEP_SUMMARY
