name: 🔬 Testar Scripts

on:
  pull_request:
    paths:
      - 'scripts/generate-c4.sh'
      - 'docs/c4/**'

jobs:
  test-generate-c4:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Configura Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instala plantuml-cli
        run: npm install -g plantuml-cli

      - name: Executa teste do script generate-c4
        run: |
          set -e
          mkdir -p docs/c4
          if [ ! -f scripts/generate-c4.sh ]; then
            echo "⚠️ scripts/generate-c4.sh não encontrado; pulando teste."
            exit 0
          fi
          # Garante um arquivo .puml para teste se nenhum existir
          if ! ls docs/c4/*.puml >/dev/null 2>&1; then
            cat > docs/c4/test.puml <<'EOP'
@startuml
A -> B : exemplo
@enduml
EOP
          fi
          bash scripts/generate-c4.sh
          # Verifica se gerou pelo menos um SVG
          if ! ls docs/c4/*.svg >/dev/null 2>&1; then
            echo "::error::Nenhum SVG gerado pelo script generate-c4.sh"
            exit 1
          fi
          echo "✅ Script generate-c4.sh gerou SVGs com sucesso."
